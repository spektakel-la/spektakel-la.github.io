---
layout: page
title: Locations
permalink: /locations
---

<div class="spektakel-leaflet-map"></div>
<div class="spektakel-leaflet-map-attribution">
  &copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>
</div>

<script>

  const LOCATIONS = {{ site.locations | jsonify }};
  const ARTISTS = {{ site.artists | jsonify }};
  const SCHEDULE = {{ site.data.schedule | jsonify }};

  const createIconMarkup = (locationObj) => `
  <div class="spektakel-leaflet-location-icon-container">
    <div>
      ${locationObj.location_id}
    </div>
  </div>
  `;

  const createScheduleMarkupForLocation = (locationId) => {
    const scheduleForLocation = SCHEDULE.filter((entry) => entry.location_id === locationId);
    const scheduleForLocationWithArtist = scheduleForLocation.map((entry) => {
      const artist = ARTISTS.find((artist) => artist.artist_id === entry.artist_id);
      if (artist?.name){
        entry.artist_name = artist?.name;
        entry.categories = artist?.categories;
        return entry;
      } else {
        console.error("Error processing schedule entry");
        console.dir(entry);
      }
    });
    const tableRows = scheduleForLocationWithArtist.map((sched) => `
      <tr>
        <td>${dateFns.fp.parseISO(sched.time).toLocaleString()}</td>
        <td>${sched.artist_name}</td>
        <td>${sched.categories.join(', ')}</td>
      </tr>
    `).join('\n');

    if(!tableRows){
      return '';
    } else {
      return `
        <table>
          <tr>
           <th>Zeit</th>
            <th>Künstler</th>
            <th>Kategorien</th>
          </tr>
          ${tableRows}
        </table>
      `;
    }
  }

  const createPopupMarkup = (locationObj) => `
    <div>
      <div>Location ${locationObj.location_id} - ${locationObj.description}</div>
      <div>${createScheduleMarkupForLocation(locationObj.location_id)}</div>
    </div>
  `;

  const maxBounds = {{ site.data.settings.offline_map.bounding_rect | jsonify }};

  const map = L.map(document.querySelector('.spektakel-leaflet-map'), {
    minZoom: 16,
    maxZoom: 19,
    maxBounds,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  });
  map.attributionControl.setPrefix(false)

  const imageUrl = '{{ site.github.url }}/assets/img/map.png';
  const imageLayer = L.imageOverlay(imageUrl, maxBounds);
  imageLayer.addTo(map);

  const geoLocation = L.control.locate({
    strings: {
      title: "Zeig mir wo ich bin",
      metersUnit: "Meter",
      feetUnit: "Fuß",
      popup: "Du befindest dich innerhalb {distance} {unit} von diesem Punkt",
      outsideMapBoundsMsg: "Du scheinst Dich außerhalb der verfügbaren Kartenregion zu befinden"
    }
  });
  geoLocation.addTo(map);

  const clusterGroup = L.markerClusterGroup();
  clusterGroup.addTo(map);

  for(let location of LOCATIONS) {
    const iconSize = {{ site.data.settings.offline_map.icon_size | jsonify }};
    const iconAnchor = {{ site.data.settings.offline_map.icon_anchor | jsonify }};
    const myIcon = L.divIcon({className: 'spektakel-leaflet-location-icon', html: createIconMarkup(location), iconSize, iconAnchor});
    const [lat, lon] = location.gps;
    const myMarker = L.marker([lat, lon], {icon: myIcon});
    // myMarker.on('click', () => {
    //   map.setView([lat, long]);
    // });
    myMarker.bindPopup(createPopupMarkup(location), {className: 'spektakel-leaflet-popup', keepInView: true})
    clusterGroup.addLayer(myMarker);

    // debug position
    // L.marker([lat, lon]).addTo(map);
  }

  map.fitBounds(L.latLngBounds(LOCATIONS.map(location => location.gps)));
</script>


