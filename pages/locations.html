---
layout: page
title: Locations
permalink: /locations
---



<div class="leaflet-map"></div>
<div class="leaflet-map-attribution">
  &copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>
</div>

<script>

const locations = {{ site.data.locations | jsonify }};
const schedule = {{ site.data.schedule | jsonify }};
const artists = {{ site.data.artists | jsonify }};

  const createIconMarkup = (locationObj) => `
  <div class="leaflet-location-container">
    <div class="leaflet-location-content">
      ${locationObj.id}
    </div>
  </div>
  `;

  const createScheduleMarkupForLocation = (locationId) => {
    const scheduleForLocation = schedule.filter((entry) => entry.location_id === locationId);
    const scheduleForLocationWithArtist = scheduleForLocation.map((entry) => {
      const artist = artists.find((artist) => artist.id === entry.artist_id);
      if (artist?.name){
        entry.artist_name = artist?.name;
        return entry;
      } else {
        console.error("Error processing schedule entry");
        console.dir(entry);
      }
    });
    const tableRows = scheduleForLocationWithArtist.map((sched) => `
      <tr>
        <td>${sched.time}</td>
        <td>${sched.artist_name}</td>
      </tr>
    `).join('\n');

    if(!tableRows){
      return '';
    } else {
      return `
        <table>
          <tr>
           <th>Zeit</th>
            <th>Künstler</th>
          </tr>
          ${tableRows}
        </table>`;
    }
  }

  const createPopupMarkup = (locationObj) => `
  <div>
    <div>Location ${locationObj.id} - ${locationObj.description}</div>
    <div>${createScheduleMarkupForLocation(locationObj.id)}</div>
  </div>
  `;

  const maxBounds = {{ site.data.settings.offline_map.bounding_rect | jsonify }};

  const map = L.map(document.querySelector('.leaflet-map'), {
    minZoom: 16,
    maxZoom: 19,
    maxBounds,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  });
  map.attributionControl.setPrefix(false)

  const imageUrl = '{{ site.github.url }}/assets/img/map.png';
  const imageLayer = L.imageOverlay(imageUrl, maxBounds);
  imageLayer.addTo(map);

  const geoLocation = L.control.locate({
    strings: {
      title: "Zeig mir wo ich bin",
      metersUnit: "Meter",
      feetUnit: "Fuß",
      popup: "Du befindest dich innerhalb {distance} {unit} von diesem Punkt",
      outsideMapBoundsMsg: "Du scheinst Dich außerhalb der verfügbaren Kartenregion zu befinden"
    }
  });
  geoLocation.addTo(map);

  const clusterGroup = L.markerClusterGroup();
  clusterGroup.addTo(map);

  for(let location of locations) {
    const iconSize = {{ site.data.settings.offline_map.icon_size | jsonify }};
    const iconAnchor = {{ site.data.settings.offline_map.icon_anchor | jsonify }};
    const myIcon = L.divIcon({className: 'leaflet-location-icon', html: createIconMarkup(location), iconSize, iconAnchor});
    const myMarker = L.marker([location.lat, location.lon], {icon: myIcon});
    // myMarker.on('click', () => {
    //   map.setView([location.lat, location.lon]);
    // });
    myMarker.bindPopup(createPopupMarkup(location))
    clusterGroup.addLayer(myMarker);

    // debug position
    // L.marker([location.lat, location.lon]).addTo(map);
  }

  map.fitBounds(L.latLngBounds(locations.map(location => [location.lat, location.lon])));
  </script>


